nodeJS版个人支付免签系统
技术栈 Koa2 + Vue + Mysql + Redis 

## Api 版本出炉了 强烈推荐使用

1. 解决支付宝二维码生成次数限制，从此远离手动生成固额二维码；

2. 提供完整的服务端源代码，并提供详细Api文档和代码注释，已更新视频教程;

3. 开源，你可以随时下载服务端最新的代码!


-------------------------------------------

### 请详细阅读此文档

此项目主要用来解决没有营业执照，想使用微信和支付宝收款的个人开发者，此项目综合了订单系统，和商品系统，如果你仅需要接入订单支付请使用Api版，支持回调通知；

特点：支付回调通知，0手续费实时到账（不经过任何第三方，直接到账微信/支付宝余额），全部服务端源代码，支持php/java/python等语言直接接入(请使用Api版本傻瓜式接入)，监听方式非xp框架HOOK的方式（此方式存在风险），独立App监听安全无风险，无需root权限;

实现原理： 当收到支付宝、微信、实时收款信息，客户端会实时通知服务器收款金额和方式，服务器收到有效期订单金额后处理订单状态，使用随机减免的方式区分订单（5分钟订单有效期内有相同金额的订单会随机减免0.01 - 0.10的方式用来区分订单）;

后台 账号密码 admin


## 使用任何个人支付都要注意

1.支付宝收款二维码现在每天生成上限制20张（请合理生成刚需二维码）；

2.不要使用HOOK的方式，会被风控（就是你们想要的订单备注，自动生成定额二维码，此方法已经被和谐了，见第一条，请勿使用），本项目使用的是独立App监听“系统”状态栏通知，安全无风险;

3.~~所有定额二维码都无法唤醒最新支付宝支付,目前已经无法通过手机浏览器打开支付宝App付款~~，api版暂时可以唤醒;

4.所有二清的平台决不可使用;

##定制订单处理（客户端通知接口请求路由及格式）

如果你需要了解客户端推送内容或想自己接收处理客户端推送的内容，客户端收款推送的逻辑在/api/addons/pay.js文件里；

  接收客户端通知需要两个步骤
 
    1):验证客户端
    
       请求地址: http(s)://你的服务器地址/addons/pay/api/setting
       
       请求方式: get
       
       请求参数：
       
         sign  // 客户端加密后的密匙  加密方式 md5(md5(apiurl) + secretkey));
         
         apiurl // 客户端填写的Api地址 务必填写 http(s)://你的服务器地址/addons/pay/ 必须"/"结尾;
         
        服务端处理参数：
        
          secretkey 是服务端配置的加密secretkey，需要和客户端填写的secretkey一致;
         
          判断逻辑如下 
          
          if (sign == md5(md5(apiurl) + secretkey)) // 当客户端加密的sign 和服务器加密的 sign一直则通过，加密方式 md5(md5(apiurl) + secretkey)
         
        响应值
         
           {
              code: 1,  // 1成功 0 失败
              
              msg: '配置成功!', // 提示信息
              
              data: '', // 默认
              
              url: '', // 默认
              
              wait: 3  // 默认
              
            }
         
       2):当客户端配置成功后，监听到收款信息就会向服务端推送信息，如下；
        
         请求地址: http(s)://你的服务器地址/addons/pay/api/notify

         请求方式: get

         请求参数：

           sign  // 客户端加密后的密匙  加密方式 md5(md5(price + type) + secretkey));

           price // 支付宝/微信收款到账金额;
           
           type  // wechat 或者 alipay 对应微信和支付宝
           

          服务端处理参数：

            secretkey 是服务端配置的加密secretkey，客户端填写的secretkey需要和服务端的secretkey一致，一致即配置成功;

            if (sign == md5(md5(price + type) + secretkey)) // 后面就可以处理你的订单状态了

          响应值
       
           {
              code: 1,  // 1成功 0 失败
              
              msg: '收款处理成功!', // 提示信息
              
              data: '', // 默认
              
              url: '', // 默认
              
              wait: 3  // 默认
              
            }
       
       
     参考：/api/addons/pay.js 

### 安装方式

    !!! 依赖nodeJS（必须） + mysql（必须） + redis 环境 （Api版本没有限制下单频率非必须Redis）

    1.下载全部源码；

    2.修改 /com目录中 config.js 和 email.js 文件；

    3.在项目根目录中运行 npm install 安装依赖；

    4.在根目录中运行 node app.js 默认端口80，没有错误信息,访问服务器地址即可访问，如果80端口被占用，请开启其他端口或使用Nginx转发;

    5.监听运行建议使用 pm2 ;
    
----------
### 使用方法

    1.添加商品

   ![添加商品][1]

  注意，这里的价格设置的是一元
  
  2.上传收款二维码
  
   ![收款二维码][2]

        为了避免同一金额在同一时间被支付，使用随机立减的方式在5分钟内，不会重复生成订单,在商品的金额上随机下调不超过0.10元;
        
        那么一个1元的商品需要上传 1.00、0.99、0.98 ... 0.92 、0.91 十个微信+支付宝收款二维码;
     

3.商品的地址统一是

    http://你的服务器地址/#/goods/DwnNGCW4VLk1CjemIiUqf

    "DwnNGCW4VLk1CjemIiUqf"是商品nanoid

4.客户端配置说明

    api 地址填写： http(s)://你的服务器地址/addons/pay/ 注意：必须以反斜杠结尾

    签名密匙填写： config.js里的 secretkey 值
    
    点击保存提示配置成功即可，没有其他设置!
    

5.请把支付宝/微信/收款客户端加入手机清理白名单，并保持网络畅通；

6.请开启微信/支付宝收款通知
 
  开启方式 
  
    微信->钱包->二维码收款->开启收款到账语音提醒  
    
    注：（如果微信在PC登录了，请在手机微信中关闭手机静音，或退出PC微信）
    
    支付宝->收钱->开启收款到账语音提醒
    


